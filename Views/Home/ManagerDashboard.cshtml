@model IEnumerable<EmployeeAchievementss.Models.Achievement>
@{
    ViewBag.Title = "لوحة المدير";
    var manager = ViewBag.Manager;
}

<div class="container mt-5">
    <h2 class="mb-4">لوحة المدير - @manager?.Department?.Name</h2>

    <div class="card mb-4">
        <div class="card-header">توليد التقارير</div>
        <div class="card-body">
            <form id="reportForm" class="row g-2 align-items-center">
                <div class="col-auto">
                    <select class="form-select" id="reportType" name="type" onchange="toggleReportFilters()">
                        <option value="summary">ملخص</option>
                        <option value="byEmployee">حسب الموظف</option>
                        <option value="byDate">حسب التاريخ</option>
                    </select>
                </div>
                <div class="col-auto" id="employeeFilter" style="display:none;">
                    <select class="form-select" id="employeeId" name="employeeId">
                        <option value="">اختر الموظف</option>
                        @foreach (var emp in ViewBag.Employees as List<EmployeeAchievementss.Models.User>)
                        {
                            <option value="@emp.Id">@emp.Name</option>
                        }
                    </select>
                </div>
                <div class="col-auto" id="dateFilter" style="display:none;">
                    <input type="date" class="form-control" id="startDate" name="startDate" />
                    <input type="date" class="form-control" id="endDate" name="endDate" />
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">توليد التقرير</button>
                </div>
            </form>
            <div id="reportResult" class="mt-3"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">الإنجازات المعلقة</div>
        <div class="card-body">
            @if (!Model.Any())
            {
                <div class="alert alert-info">لا توجد إنجازات معلقة في القسم الخاص بك.</div>
            }
            else
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>العنوان</th>
                            <th>الوصف</th>
                            <th>الموظف</th>
                            <th>التاريخ</th>
                            <th>الصور</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var achievement in Model)
                        {
                            <tr id="achievement-row-@achievement.Id">
                                <td>@achievement.Title</td>
                                <td>@achievement.Description</td>
                                <td>@achievement.Owner?.Name</td>
                                <td>@achievement.Date.ToString("yyyy-MM-dd")</td>
                                <td>
                                    @if (achievement.HasPhotos)
                                    {
                                        <button class="btn btn-info btn-sm" onclick="showAchievementPhotos(@achievement.Id)">
                                            <i class="bi bi-images"></i> عرض الصور (@achievement.Photos.Count)
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="text-muted">لا توجد صور</span>
                                    }
                                </td>
                                <td>
                                    <button class="btn btn-success btn-sm me-1" onclick="approveAchievement(@achievement.Id)">موافقة</button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectAchievement(@achievement.Id)">رفض</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/managerDashboard.js?v=@DateTime.Now.Ticks"></script>
    <script src="~/js/photo-upload.js?v=@DateTime.Now.Ticks"></script>
    <script>
        // Fallback function definition in case the main script doesn't load
        if (typeof showAchievementPhotos === 'undefined') {
            function showAchievementPhotos(achievementId) {
                fetch(`/Home/GetAchievementPhotos?achievementId=${achievementId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showPhotoModal(data.photos);
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('حدث خطأ أثناء جلب الصور');
                    });
            }
        }
        
        if (typeof showPhotoModal === 'undefined') {
            function showPhotoModal(photos) {
                // Create modal if it doesn't exist
                let modal = document.getElementById('photoModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'photoModal';
                    modal.className = 'modal fade';
                    modal.setAttribute('tabindex', '-1');
                    modal.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">صور الإنجاز</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="photoCarousel" class="carousel slide" data-bs-ride="carousel">
                                        <div class="carousel-inner" id="photoCarouselInner">
                                        </div>
                                        <button class="carousel-control-prev" type="button" data-bs-target="#photoCarousel" data-bs-slide="prev">
                                            <span class="carousel-control-prev-icon"></span>
                                        </button>
                                        <button class="carousel-control-next" type="button" data-bs-target="#photoCarousel" data-bs-slide="next">
                                            <span class="carousel-control-next-icon"></span>
                                        </button>
                                    </div>
                                    <div class="mt-3">
                                        <div class="row" id="photoThumbnails">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                // Populate carousel
                const carouselInner = modal.querySelector('#photoCarouselInner');
                const thumbnailsContainer = modal.querySelector('#photoThumbnails');
                
                carouselInner.innerHTML = '';
                thumbnailsContainer.innerHTML = '';

                photos.forEach((photo, index) => {
                    // Add carousel item
                    const carouselItem = document.createElement('div');
                    carouselItem.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                    carouselItem.innerHTML = `
                        <img src="${photo.filePath}" class="d-block w-100" alt="Achievement Photo" style="max-height: 400px; object-fit: contain;">
                        <div class="carousel-caption d-none d-md-block">
                            <p>${photo.originalFileName}</p>
                        </div>
                    `;
                    carouselInner.appendChild(carouselItem);

                    // Add thumbnail
                    const thumbnailCol = document.createElement('div');
                    thumbnailCol.className = 'col-2 mb-2';
                    thumbnailCol.innerHTML = `
                        <img src="${photo.thumbnailPath}" class="img-thumbnail" alt="Thumbnail" 
                             style="cursor: pointer; height: 60px; object-fit: cover;" 
                             onclick="goToSlide(${index})">
                    `;
                    thumbnailsContainer.appendChild(thumbnailCol);
                });

                // Show modal
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            }
        }
        
        if (typeof goToSlide === 'undefined') {
            function goToSlide(index) {
                const carousel = document.querySelector('#photoCarousel');
                const bsCarousel = new bootstrap.Carousel(carousel);
                bsCarousel.to(index);
            }
        }
    </script>
} 