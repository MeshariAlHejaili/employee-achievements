@using EmployeeAchievementss.Models
@model List<Achievement>
@{
    ViewData["Title"] = "Home Page";
    var currentUserId = ViewBag.CurrentUserId as int?;
}

@functions {
    public string GetPhotoGridClass(int photoCount)
    {
        return photoCount switch
        {
            1 => "single-photo",
            2 => "two-photos",
            3 => "three-photos",
            _ => "four-photos"
        };
    }
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

<div class="feed-container">
    @Html.AntiForgeryToken()
    <!-- Search Bar -->
    <div class="search-container">
        <input type="text" class="search-input" placeholder="ابحث في الإنجازات..." />
        @if (Context.Session.GetString("IsManager") == "true")
        {
            <input type="text" class="search-id-input ms-2" placeholder="بحث بالمعرّف..." style="max-width: 160px;" />
        }
    </div>

    <!-- Achievement Feed -->
    @if (Model != null && Model.Any())
    {
        @foreach (var achievement in Model)
        {
            <div class="achievement-card" data-achievement-id="@achievement.Id">
                <!-- Header -->
                <div class="achievement-header">
                    <div class="profile-pic">
                        @(achievement.Owner?.Name?.Substring(0, 1) ?? "?")
                    </div>
                    <div class="user-info">
                        <h6>@achievement.Owner?.Name</h6>
                        <p>@achievement.Owner?.Position • @achievement.Owner?.DepartmentRef?.Name</p>
                    </div>
                </div>

                <!-- Content -->
                <div class="achievement-content">
                    <div class="achievement-title">@achievement.Title</div>
                    <div class="achievement-description">@achievement.Description</div>
                    <div class="achievement-date">
                        <i class="bi bi-clock"></i> @achievement.Date.ToString("MMMM dd, yyyy")
                    </div>
                </div>

                <!-- Photos -->
                @if (achievement.HasPhotos)
                {
                    <div class="achievement-photos">
                        <div class="achievement-photos-container @GetPhotoGridClass(achievement.Photos.Count)">
                            @{
                                var displayPhotos = achievement.Photos.Take(4).ToList();
                                var photoCount = achievement.Photos.Count;
                            }
                            @for (int i = 0; i < displayPhotos.Count; i++)
                            {
                                var photo = displayPhotos[i];
                                var isMorePhotos = i == 3 && photoCount > 4;
                                
                                <div class="photo-item @(isMorePhotos ? "more-photos" : "")">
                                    @if (isMorePhotos)
                                    {
                                        <span>+@(photoCount - 4)</span>
                                    }
                                    else
                                    {
                                        <img src="/uploads/achievements/@photo.FullFileName" alt="Achievement Photo" />
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Stats -->
                <div class="achievement-stats">
                    <span>@achievement.LikesCount إعجاب • @achievement.CommentsCount تعليق</span>
                </div>

                <!-- Actions -->
                <div class="achievement-actions">
                    <button class="action-btn like-btn @(achievement.IsLikedByCurrentUser ? "liked" : "")" 
                            data-achievement-id="@achievement.Id">
                        <i class="bi @(achievement.IsLikedByCurrentUser ? "bi-heart-fill" : "bi-heart")"></i>
                        إعجاب
                    </button>
                    <button class="action-btn comment-btn" data-achievement-id="@achievement.Id">
                        <i class="bi bi-chat"></i>
                        تعليق
                    </button>
                    <button class="action-btn share-btn">
                        <i class="bi bi-share"></i>
                        مشاركة
                    </button>
                    @if (currentUserId.HasValue && achievement.OwnerId == currentUserId.Value)
                    {
                        <div class="dropdown">
                            <button class="action-btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="@Url.Action("Edit", new { id = achievement.Id })">
                                    <i class="bi bi-pencil me-2"></i>تعديل
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" 
                                       onclick="deleteAchievement(@achievement.Id)">
                                    <i class="bi bi-trash me-2"></i>حذف
                                </a></li>
                            </ul>
                        </div>
                    }
                </div>

                <!-- Comments Section -->
                <div class="comments-section" id="comments-@achievement.Id" style="display: none;">
                    @foreach (var comment in achievement.Comments)
                    {
                        <div class="comment">
                            <div class="comment-pic">
                                @(comment.User.Name.Substring(0, 1))
                            </div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">@comment.User.Name</span>
                                    <span class="comment-date">@comment.Date.ToString("MMM dd, HH:mm")</span>
                                </div>
                                <div class="comment-text">@comment.Content</div>
                            </div>
                        </div>
                    }
                    
                    <!-- Add Comment -->
                    <div class="add-comment">
                        <div class="comment-pic">
                            @(Context.Session.GetString("UserName")?.Substring(0, 1) ?? "?")
                        </div>
                        <input type="text" class="comment-input" placeholder="اكتب تعليقاً..." />
                        <button class="post-comment-btn">إرسال</button>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h4>لا توجد إنجازات بعد</h4>
            <p>كن أول من يشارك إنجازه!</p>
        </div>
    }
</div>

<!-- Add Achievement Button -->
<button class="add-achievement-btn" onclick="location.href='@Url.Action("AddAchievement")'">
    <i class="bi bi-plus"></i>
</button>

@section Scripts {
    <script src="~/js/feed.js"></script>
    <script src="~/js/photo-upload.js"></script>
}
